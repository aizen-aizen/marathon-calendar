# マラソン大会管理アプリ 要件定義書

## 概要

マラソン大会の情報を閲覧し、お気に入り登録した大会の申込開始日が近づいたらブラウザ通知でリマインドするWebアプリケーション。

---

## 技術スタック

| コンポーネント | 技術 |
|---------------|------|
| ホスティング | GitHub Pages |
| 認証 | Firebase Authentication（Googleログイン） |
| データベース | Firebase Firestore |
| 通知 | Firebase Cloud Messaging (FCM) |
| スケジューラ | Firebase Cloud Functions |
| フレームワーク | Vanilla JS + HTML/CSS（シンプルさ重視） |

---

## 機能要件

### 1. 大会一覧表示

- `data/marathons.json` から大会情報を読み込み一覧表示
- 表示項目：
  - 大会名
  - 種別（フルマラソン / ウルトラマラソン）
  - 開催日
  - 定員
  - 申込開始日
  - 申込締切日
  - 申込方法（先着 / 抽選）
  - 倍率（抽選の場合）
- フィルタリング機能：
  - 種別で絞り込み
  - 申込受付中のみ表示

### 2. ユーザー認証

- Googleアカウントでログイン/ログアウト
- ログイン状態の永続化
- 未ログイン時はお気に入り機能を制限（閲覧のみ可能）

### 3. お気に入り登録

- 各大会に「お気に入り」ボタンを配置
- お気に入り登録時にFirestoreへ保存
- ユーザーごとにお気に入りリストを管理

### 4. 大会参加ステータス管理

お気に入り登録した大会について、以下のステータスを記録：

| ステータス | 説明 | 値 |
|-----------|------|-----|
| 申し込み | 大会へ申し込んだか | 未 / 申込済 / 当選待ち / 落選 |
| 宿泊 | 宿を確保したか | 未 / 予約済 / 不要 |
| 移動手段 | 交通手段を確保したか | 未 / 飛行機 / 新幹線 / 電車 / 車 / バス / 不要 |

### 5. ブラウザ通知（プッシュ通知）

- **通知タイミング**：
  - 申込開始日の **7日前**
  - 申込開始日の **1日前**
- **通知内容**：
  - 大会名
  - 申込開始日
  - 直接リンク（タップでアプリの該当大会を開く）
- **通知許可フロー**：
  - 初回お気に入り登録時に通知許可を求める
  - 許可しない場合でもアプリ内でリマインダー表示

---

## データ構造

### Firestore コレクション設計

```
users/
  {userId}/
    profile/
      displayName: string
      email: string
      fcmToken: string  // プッシュ通知用トークン
    
    favorites/
      {marathonId}/
        marathonName: string
        entryStart: timestamp
        status:
          application: "none" | "applied" | "waiting" | "rejected"
          accommodation: "none" | "booked" | "not_needed"
          transportation: "none" | "plane" | "shinkansen" | "train" | "car" | "bus" | "not_needed"
        notificationSent:
          sevenDays: boolean
          oneDay: boolean
        createdAt: timestamp
        updatedAt: timestamp
```

### marathons.json からのマラソンID生成

- 大会名をハッシュ化、または正規化してIDとして使用
- 例: `東京マラソン` → `tokyo-marathon-2026`

---

## 画面構成

### 1. トップページ（大会一覧）
```
┌─────────────────────────────────────┐
│ 🏃 マラソン大会カレンダー    [ログイン] │
├─────────────────────────────────────┤
│ [フルマラソン] [ウルトラ] [受付中のみ]  │
├─────────────────────────────────────┤
│ 📅 2026年2月                          │
│ ┌─────────────────────────────────┐  │
│ │ ⭐ 東京マラソン                    │  │
│ │ 2026/03/01 | 定員38,000 | 抽選   │  │
│ │ 申込: 2025/08/15〜08/29          │  │
│ └─────────────────────────────────┘  │
│ ...                                   │
└─────────────────────────────────────┘
```

### 2. マイページ（お気に入り一覧）
```
┌─────────────────────────────────────┐
│ 🏃 マイ大会                [ログアウト] │
├─────────────────────────────────────┤
│ ┌─────────────────────────────────┐  │
│ │ ⭐ 東京マラソン         [削除]    │  │
│ │ 申込開始まで: あと23日            │  │
│ │ ┌───────────────────────────┐   │  │
│ │ │ 申込: [●申込済] [ ]当選待ち    │   │  │
│ │ │ 宿泊: [●予約済] [ ]不要       │   │  │
│ │ │ 移動: [●新幹線]              │   │  │
│ │ └───────────────────────────┘   │  │
│ └─────────────────────────────────┘  │
└─────────────────────────────────────┘
```

---

## 通知処理フロー

```
┌─────────────────┐
│ Cloud Functions │
│ (毎日 09:00 実行) │
└────────┬────────┘
         │
         ▼
┌─────────────────────────┐
│ Firestoreから全ユーザーの │
│ お気に入りを取得          │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 本日が通知対象日か判定    │
│ - 申込開始7日前？         │
│ - 申込開始1日前？         │
└────────┬────────────────┘
         │ 該当あり
         ▼
┌─────────────────────────┐
│ FCMでプッシュ通知送信     │
│ notificationSent を更新  │
└─────────────────────────┘
```

---

## 非機能要件

### パフォーマンス
- 初回ロード: 3秒以内
- ページ遷移: 1秒以内

### セキュリティ
- Firestoreセキュリティルール設定（ユーザーは自分のデータのみ読み書き可能）
- FCMトークンの安全な管理

### 対応環境
- Chrome、Safari、Firefox（最新版）
- iOS Safari（PWAとしてホーム画面追加時のみ通知対応）
- Android Chrome

---

## 開発フェーズ

### Phase 1: 基本機能（MVP）
1. [ ] 大会一覧表示
2. [ ] Googleログイン
3. [ ] お気に入り登録/解除
4. [ ] GitHub Pagesへのデプロイ

### Phase 2: ステータス管理
1. [ ] 参加ステータス（申込/宿泊/移動）の記録
2. [ ] マイページの実装

### Phase 3: 通知機能
1. [ ] Firebase Cloud Functions設定
2. [ ] FCM統合
3. [ ] 通知スケジューラ実装

### Phase 4: 改善
1. [ ] PWA対応
2. [ ] オフライン対応
3. [ ] UI/UX改善

---

## 費用見積もり

| 項目 | 無料枠 | 想定利用量 | 費用 |
|-----|-------|-----------|------|
| GitHub Pages | 無制限 | - | 無料 |
| Firebase Auth | 50K MAU | 〜100人 | 無料 |
| Firestore | 1GB, 50K reads/day | 〜10MB | 無料 |
| Cloud Functions | 2M calls/month | 〜1K calls/month | 無料 |
| FCM | 無制限 | - | 無料 |

**想定月額コスト: ¥0**（小規模利用の場合）
